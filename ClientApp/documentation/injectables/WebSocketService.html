<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>d_d_backend documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">d_d_backend documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li>WebSocketService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/websocket/index.ts</code>
        </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Optional</span>
                                <a href="#_newestCampaign">_newestCampaign</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Optional</span>
                                <a href="#_username">_username</a>
                            </li>
                            <li>
                                <a href="#announcement$">announcement$</a>
                            </li>
                            <li>
                                <a href="#auth$">auth$</a>
                            </li>
                            <li>
                                <a href="#fetchedCampaigns$">fetchedCampaigns$</a>
                            </li>
                            <li>
                                <a href="#gameState$">gameState$</a>
                            </li>
                            <li>
                                <a href="#joinableCampaigns$">joinableCampaigns$</a>
                            </li>
                            <li>
                                <a href="#signOut">signOut</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#socket">socket</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#onMessage">onMessage</a>
                            </li>
                            <li>
                                <a href="#sendSomething">sendSomething</a>
                            </li>
                            <li>
                                <a href="#startSocket">startSocket</a>
                            </li>
                        </ul>
                    </td>
                </tr>





                    <tr>
                        <td class="col-md-4">
                            <h6><b>Accessors</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                    <a href="#username">username</a>
                                </li>
                                <li>
                                    <a href="#requestBuilders">requestBuilders</a>
                                </li>
                                <li>
                                    <a href="#newestCampaign">newestCampaign</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
        </tbody>
    </table>
</section>


            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="onMessage"></a>
                    <span class="name">
                        <b>
                            <span class="modifier">Private</span>
                            onMessage
                        </b>
                        <a href="#onMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>onMessage(msg: MessageEvent)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="41"
                            class="link-to-prism">src/websocket/index.ts:41</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>msg</td>
                                    <td>
                                            <code>MessageEvent</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sendSomething"></a>
                    <span class="name">
                        <b>
                            sendSomething
                        </b>
                        <a href="#sendSomething"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>sendSomething()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="111"
                            class="link-to-prism">src/websocket/index.ts:111</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="startSocket"></a>
                    <span class="name">
                        <b>
                            startSocket
                        </b>
                        <a href="#startSocket"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>startSocket()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="22"
                            class="link-to-prism">src/websocket/index.ts:22</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="_newestCampaign"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                                <span class="modifier">Optional</span>
                            _newestCampaign</b>
                            <a href="#_newestCampaign"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="../interfaces/GameStateCampaign.html" target="_self" >GameStateCampaign</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="20" class="link-to-prism">src/websocket/index.ts:20</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="_username"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                                <span class="modifier">Optional</span>
                            _username</b>
                            <a href="#_username"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="14" class="link-to-prism">src/websocket/index.ts:14</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="announcement$"></a>
                        <span class="name">
                            <b>
                            announcement$</b>
                            <a href="#announcement$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>new BehaviorSubject(&#x27;&#x27;)</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="15" class="link-to-prism">src/websocket/index.ts:15</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="auth$"></a>
                        <span class="name">
                            <b>
                            auth$</b>
                            <a href="#auth$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>new BehaviorSubject(false)</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="16" class="link-to-prism">src/websocket/index.ts:16</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="fetchedCampaigns$"></a>
                        <span class="name">
                            <b>
                            fetchedCampaigns$</b>
                            <a href="#fetchedCampaigns$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>new BehaviorSubject(new Map&lt;number, Campaign&gt;())</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="18" class="link-to-prism">src/websocket/index.ts:18</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="gameState$"></a>
                        <span class="name">
                            <b>
                            gameState$</b>
                            <a href="#gameState$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>new BehaviorSubject&lt;GameState | null&gt;(null)</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="19" class="link-to-prism">src/websocket/index.ts:19</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="joinableCampaigns$"></a>
                        <span class="name">
                            <b>
                            joinableCampaigns$</b>
                            <a href="#joinableCampaigns$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>new BehaviorSubject&lt;Campaign[]&gt;([])</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="17" class="link-to-prism">src/websocket/index.ts:17</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="signOut"></a>
                        <span class="name">
                            <b>
                            signOut</b>
                            <a href="#signOut"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="36" class="link-to-prism">src/websocket/index.ts:36</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="socket"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Private</span>
                            socket</b>
                            <a href="#socket"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>WebSocket</code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="13" class="link-to-prism">src/websocket/index.ts:13</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>

            <section>
    <h3 id="accessors">
        Accessors
    </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="username"></a>
                        <span class="name"><b>username</b><a href="#username"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>username()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="37" class="link-to-prism">src/websocket/index.ts:37</a></div>
                                </td>
                            </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="requestBuilders"></a>
                        <span class="name"><b>requestBuilders</b><a href="#requestBuilders"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>requestBuilders()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="103" class="link-to-prism">src/websocket/index.ts:103</a></div>
                                </td>
                            </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="newestCampaign"></a>
                        <span class="name"><b>newestCampaign</b><a href="#newestCampaign"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>newestCampaign()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="107" class="link-to-prism">src/websocket/index.ts:107</a></div>
                                </td>
                            </tr>

            </tbody>
        </table>
</section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { isLoginInfo } from &#x27;./responses/LoginInfo&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;
import { BehaviorSubject } from &#x27;rxjs&#x27;;
import requestBuilder from &#x27;./requestBuilder&#x27;;
import { Campaign, isCampaign, isCampaignArray } from &#x27;./responses/Campaigns&#x27;;
import { GameState, GameStateCampaign } from &#x27;./responses/GameState&#x27;;
import { isDiceRoll } from &#x27;./responses/DiceRoll&#x27;;

@Injectable({
    providedIn: &#x27;root&#x27;,
})
export class WebSocketService {
    private socket: WebSocket;
    private _username?: string;
    announcement$ &#x3D; new BehaviorSubject(&#x27;&#x27;);
    auth$ &#x3D; new BehaviorSubject(false);
    joinableCampaigns$ &#x3D; new BehaviorSubject&lt;Campaign[]&gt;([]);
    fetchedCampaigns$ &#x3D; new BehaviorSubject(new Map&lt;number, Campaign&gt;());
    gameState$ &#x3D; new BehaviorSubject&lt;GameState | null&gt;(null);
    private _newestCampaign?: GameStateCampaign;

    startSocket() {
        this.socket &#x3D; new WebSocket(&#x27;wss://localhost:5001/ws&#x27;);
        this.socket.addEventListener(&#x27;open&#x27;, o &#x3D;&gt; {
            console.log(&#x27;did open&#x27;, o);
            this.announcement$.next(&#x27;Opened&#x27;);
        });
        this.socket.addEventListener(&#x27;message&#x27;, r &#x3D;&gt; this.onMessage(r));
        this.socket.addEventListener(&#x27;error&#x27;, o &#x3D;&gt; console.log(&#x27;e&#x27;, o));
        this.socket.addEventListener(&#x27;close&#x27;, o &#x3D;&gt;
            console.log(&#x27;server closed&#x27;, o)
        );
    }

    // Auth
    signOut &#x3D; () &#x3D;&gt; this.auth$.next(false);
    public get username() {
        return this._username;
    }

    private onMessage(msg: MessageEvent) {
        console.log(&#x27;Got message&#x27;, msg);
        try {
            const parsed &#x3D; JSON.parse(msg.data);
            if (isLoginInfo(parsed)) {
                this._username &#x3D; parsed.username;
                this.auth$.next(true);
                this.requestBuilders.update();
                return;
            }
            if (isCampaign(parsed)) {
                const fetchedNow &#x3D; this.fetchedCampaigns$.value;
                fetchedNow.set(parsed.ID, parsed);
                this.fetchedCampaigns$.next(fetchedNow);
                return;
            }
            if (isCampaignArray(parsed)) {
                this.joinableCampaigns$.next(parsed);
                return;
            }
            if (isDiceRoll(parsed)) {
                // Then we modidy the current gameState to fit
                const gotGameState &#x3D; this.gameState$.value;
                if (gotGameState) {
                    const currentRolls &#x3D;
                        gotGameState.diceRolls?.[parsed.campaign] ?? [];
                    if (currentRolls.length !&#x3D;&#x3D; 0) {
                        const newRolls &#x3D; [...currentRolls, parsed]
                            .sort(
                                (a, b) &#x3D;&gt;
                                    new Date(b.date).getTime() -
                                    new Date(a.date).getTime()
                            )
                            .slice(0, 5);
                        this.gameState$.next({
                            ...gotGameState,
                            diceRolls: {
                                ...gotGameState.diceRolls,
                                [parsed.campaign]: newRolls,
                            },
                        });
                    }
                }
                return;
            }
            // Since we&#x27;ve parsed some JSON, and the response was not the other types, this must be a gameState
            const gameState &#x3D; parsed as GameState;
            // We also check if we got a new campaign
            const newCampaigns &#x3D; gameState.ownedCampaigns ?? [];
            const oldCampaigns &#x3D; this.gameState$.value?.ownedCampaigns ?? [];
            // If there is a new element, we set that as the _newestCampaign property
            const added &#x3D; newCampaigns.filter(c &#x3D;&gt;
                oldCampaigns.some(oC &#x3D;&gt; oC.ID &#x3D;&#x3D;&#x3D; c.ID)
            );
            if (added.length &gt; 0) this._newestCampaign &#x3D; added[0];
            console.log(&#x27;Got game state&#x27;, parsed);
            this.gameState$.next(parsed);
        } catch (e) {
            console.log(&#x27;Got error from websocket&#x27;, msg);
        }
    }

    get requestBuilders() {
        return requestBuilder(this.socket);
    }

    get newestCampaign() {
        return this._newestCampaign;
    }

    sendSomething() {
        this.socket.send(
            JSON.stringify({
                type: &#x27;Login&#x27;,
                payload: JSON.stringify({
                    username: &#x27;s185023&#x27;,
                    password: &#x27;12345678&#x27;,
                }),
            })
        );
        console.log(&#x27;did send something&#x27;);
    }
}
</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'WebSocketService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
